import{c as k,s as qe,a as fe,b as ze}from"./camera-783e324d.js";import{b as Le}from"./index-e15a2295.js";const Ue=(e,t)=>e.texture({width:1,height:1,type:t?"half float":"uint8",wrap:"clamp",min:"linear",mag:"linear"}),S=(e,t)=>e.framebuffer({color:Ue(e,t)}),He=(e,t)=>{const r=Array(2).fill().map(()=>e.framebuffer({color:e.texture(t),depthStencil:!1}));return{front:({tick:a})=>r[a%2],back:({tick:a})=>r[(a+1)%2]}},me=e=>Math.log2(e)%1==0,q=(e,t,r)=>{let a=e.texture([[0]]),o=!1;return{texture:()=>(!o&&t!=null&&console.warn(`texture still loading: ${t}`),a),width:()=>(!o&&t!=null&&console.warn(`texture still loading: ${t}`),o?a.width:1),height:()=>(!o&&t!=null&&console.warn(`texture still loading: ${t}`),o?a.height:1),loaded:(async()=>{if(t!=null){const s=new Image;s.crossOrigin="anonymous",s.src=t,await s.decode(),o=!0,r&&((!me(s.width)||!me(s.height))&&console.warn(`Can't mipmap a non-power-of-two image: ${t}`),r=!1),a=e.texture({data:s,mag:"linear",min:r?"mipmap":"linear",flipY:!0})}})()}},g=e=>{let t="",r=!1;return{text:()=>(r||console.warn(`text still loading: ${e}`),t),loaded:(async()=>{e!=null&&(t=await(await fetch(e)).text(),r=!0)})()}},Oe=(e,t={},r={})=>e({vert:`
		precision mediump float;
		attribute vec2 aPosition;
		varying vec2 vUV;
		void main() {
			vUV = 0.5 * (aPosition + 1.0);
			gl_Position = vec4(aPosition, 0, 1);
		}
	`,frag:`
		precision mediump float;
		varying vec2 vUV;
		uniform sampler2D tex;
		void main() {
			gl_FragColor = texture2D(tex, vUV);
		}
	`,attributes:{aPosition:[-4,-4,4,-4,0,4]},count:3,uniforms:{...t,time:e.context("time"),tick:e.context("tick")},context:r,depth:{enable:!1}}),ve=(e,t)=>{const r=t.map(a=>a.map(o=>Math.floor(o*255))).flat();return e.texture({data:r,width:r.length/4,height:1,format:"rgba",mag:"linear",min:"linear"})},T=(e,t,r,a)=>({outputs:e??{},ready:t??Promise.resolve(),setSize:r??(()=>{}),execute:a??(()=>{})}),Xe=(e,t)=>t.filter(r=>r!=null).reduce((r,a,o)=>[...r,a(e,o==0?null:r[o-1].outputs)],[]),D=(e,t)=>Object.fromEntries(Array.from(Object.entries(e)).filter(([r])=>t.includes(r))),pe={box:0,circle:1},X=(e,t,r)=>He(e,{width:r,height:t,wrapT:"clamp",type:"half float"}),de=2*3,he=[0,0],Ye=[0,1],je=[1,0],be=[1,1],Qe=[he,Ye,be,he,be,je],Ge=({regl:e,config:t,lkg:r})=>{const a=t.volumetric,o=a&&t.effect!=="none"?t.density:1,[s,i]=[t.numColumns,Math.floor(t.numColumns*o)],[n,l]=a?[s,i]:[1,1],c=n*l,f=[1/l,1/n],b=t.rippleTypeName in pe?pe[t.rippleTypeName]:-1,v=[Math.cos(t.slant),Math.sin(t.slant)],P=1/(Math.abs(Math.sin(2*t.slant))*(Math.sqrt(2)-1)+1),d=t.effect==="none",x={...D(t,["animationSpeed","glyphHeightToWidth","glyphSequenceLength","glyphTextureGridSize"]),numColumns:i,numRows:s,showDebugView:d},M=X(e,1,i),u=g("src/matrix/shaders/glsl/rainPass.intro.frag.glsl"),m={...x,...D(t,["fallSpeed","skipIntro"])},_=e({frag:e.prop("frag"),uniforms:{...m,previousIntroState:M.back},framebuffer:M.front}),y=X(e,s,i),C=g("src/matrix/shaders/glsl/rainPass.raindrop.frag.glsl"),Te={...x,...D(t,["brightnessDecay","fallSpeed","raindropLength","loops","skipIntro"])},_e=e({frag:e.prop("frag"),uniforms:{...Te,introState:M.front,previousRaindropState:y.back},framebuffer:y.front}),G=X(e,s,i),re=g("src/matrix/shaders/glsl/rainPass.symbol.frag.glsl"),Ce={...x,...D(t,["cycleSpeed","cycleFrameSkip","loops"])},Fe=e({frag:e.prop("frag"),uniforms:{...Ce,raindropState:y.front,previousSymbolState:G.back},framebuffer:G.front}),N=X(e,s,i),ke=g("src/matrix/shaders/glsl/rainPass.effect.frag.glsl"),Me={...x,...D(t,["hasThunder","rippleScale","rippleSpeed","rippleThickness","loops"]),rippleType:b},Ee=e({frag:e.prop("frag"),uniforms:{...Me,raindropState:y.front,previousEffectState:N.back},framebuffer:N.front}),Ie=Array(n).fill().map((R,I)=>Array(l).fill().map((w,V)=>Array(de).fill([V,I]))),z=q(e,t.glyphMSDFURL),L=q(e,t.glintMSDFURL),ae=q(e,t.baseTextureURL,!0),se=q(e,t.glintTextureURL,!0),oe=g("src/matrix/shaders/glsl/rainPass.vert.glsl"),ne=g("src/matrix/shaders/glsl/rainPass.frag.glsl"),U=S(e,t.useHalfFloat),Re={...x,...D(t,["forwardSpeed","glyphVerticalSpacing","baseBrightness","baseContrast","glintBrightness","glintContrast","hasBaseTexture","hasGlintTexture","brightnessThreshold","brightnessOverride","isolateCursor","isolateGlint","glyphEdgeCrop","isPolar"]),density:o,numQuadColumns:l,numQuadRows:n,quadSize:f,slantScale:P,slantVec:v,volumetric:a},Ve=e({blend:{enable:!0,func:{src:"one",dst:"one"}},vert:e.prop("vert"),frag:e.prop("frag"),uniforms:{...Re,raindropState:y.front,symbolState:G.front,effectState:N.front,glyphMSDF:z.texture,glintMSDF:L.texture,baseTexture:ae.texture,glintTexture:se.texture,msdfPxRange:4,glyphMSDFSize:()=>[z.width(),z.height()],glintMSDFSize:()=>[L.width(),L.height()],camera:e.prop("camera"),transform:e.prop("transform"),screenSize:e.prop("screenSize")},viewport:e.prop("viewport"),attributes:{aPosition:Ie,aCorner:Array(c).fill(Qe)},count:c*de,framebuffer:U}),W=[1,1],{mat4:h,vec3:E}=glMatrix,p=h.create();a&&t.isometric?(h.rotateX(p,p,Math.PI*1/8),h.rotateY(p,p,Math.PI*1/4),h.translate(p,p,E.fromValues(0,0,-1)),h.scale(p,p,E.fromValues(1,1,2))):r.enabled?(h.translate(p,p,E.fromValues(0,0,-1.1)),h.scale(p,p,E.fromValues(1,1,1)),h.scale(p,p,E.fromValues(.15,.15,.15))):h.translate(p,p,E.fromValues(0,0,-1)),h.create();const $=[];return T({primary:U},Promise.all([z.loaded,L.loaded,ae.loaded,se.loaded,u.loaded,C.loaded,re.loaded,oe.loaded,ne.loaded]),(R,I)=>{U.resize(R,I);const w=R/I,[V,Z]=[r.tileX,r.tileY],De=Z*V,ie=Math.floor(R/V),le=Math.floor(I/Z);$.length=0;for(let H=0;H<Z;H++)for(let O=0;O<V;O++){const Ae=O+H*V,F=h.create();if(a&&t.isometric)w>1?h.ortho(F,-1.5*w,1.5*w,-1.5,1.5,-1e3,1e3):h.ortho(F,-1.5,1.5,-1.5/w,1.5/w,-1e3,1e3);else if(r.enabled){h.perspective(F,Math.PI/180*r.fov,r.quiltAspect,1e-4,1e3);const ce=-1;let K=Math.PI/180*r.viewCone*(Ae/(De-1)-.5);isNaN(K)&&(K=0);const ue=ce*Math.tan(K);h.translate(F,F,E.fromValues(ue,0,0)),F[8]=-ue/(ce*Math.tan(Math.PI/180*.5*r.fov)*r.quiltAspect)}else h.perspective(F,Math.PI/180*90,w,1e-4,1e3);const Be={x:O*ie,y:H*le,width:ie,height:le};$.push({camera:F,viewport:Be})}[W[0],W[1]]=w>1?[1,w]:[1/w,1]},R=>{if(_({frag:u.text()}),_e({frag:C.text()}),Fe({frag:re.text()}),Ee({frag:ke.text()}),R){e.clear({depth:1,color:[0,0,0,1],framebuffer:U});for(const I of $)Ve({...I,transform:p,screenSize:W,vert:oe.text(),frag:ne.text()})}})},Y=5,J=(e,t,r)=>Array(t).fill().map(a=>S(e,r)),ee=(e,t,r,a)=>e.forEach((o,s)=>o.resize(Math.floor(t*a/2**s),Math.floor(r*a/2**s))),Ne=({regl:e,config:t},r)=>{const{bloomStrength:a,bloomSize:o,highPassThreshold:s}=t;if(!(o>0&&a>0))return T({primary:r.primary,bloom:S(e)});const n=J(e,Y,t.useHalfFloat),l=J(e,Y,t.useHalfFloat),c=J(e,Y,t.useHalfFloat),f=S(e,t.useHalfFloat),b=g("src/matrix/shaders/glsl/bloomPass.highPass.frag.glsl"),v=e({frag:e.prop("frag"),uniforms:{highPassThreshold:s,tex:e.prop("tex")},framebuffer:e.prop("fbo")}),P=g("src/matrix/shaders/glsl/bloomPass.blur.frag.glsl"),d=e({frag:e.prop("frag"),uniforms:{tex:e.prop("tex"),direction:e.prop("direction"),height:e.context("viewportWidth"),width:e.context("viewportHeight")},framebuffer:e.prop("fbo")}),x=g("src/matrix/shaders/glsl/bloomPass.combine.frag.glsl"),M=e({frag:e.prop("frag"),uniforms:{bloomStrength:a,...Object.fromEntries(c.map((u,m)=>[`pyr_${m}`,u]))},framebuffer:f});return T({primary:r.primary,bloom:f},Promise.all([b.loaded,P.loaded]),(u,m)=>{ee(n,u,m,o),ee(l,u,m,o),ee(c,u,m,o),f.resize(u,m)},u=>{if(u){for(let m=0;m<Y;m++){const _=n[m],y=l[m],C=c[m];v({fbo:_,frag:b.text(),tex:m===0?r.primary:n[m-1]}),d({fbo:y,frag:P.text(),tex:_,direction:[1,0]}),d({fbo:C,frag:P.text(),tex:y,direction:[0,1]})}M({frag:x.text()})}})},We=(e,t)=>{const a=Array(2048),o=t.slice().sort((s,i)=>s.at-i.at).map(s=>({rgb:k(s.color),arrayIndex:Math.floor(Math.max(Math.min(1,s.at),0)*(2048-1))}));return o.unshift({rgb:o[0].rgb,arrayIndex:0}),o.push({rgb:o[o.length-1].rgb,arrayIndex:2048-1}),o.forEach((s,i)=>{if(a[s.arrayIndex]=s.rgb.slice(),i+1<o.length){const n=o[i+1],l=n.arrayIndex-s.arrayIndex;for(let c=0;c<l;c++){const f=c/l;a[s.arrayIndex+c]=[s.rgb[0]*(1-f)+n.rgb[0]*f,s.rgb[1]*(1-f)+n.rgb[1]*f,s.rgb[2]*(1-f)+n.rgb[2]*f]}}}),ve(e,a.map(s=>[...s,1]))},xe=({regl:e,config:t},r)=>{const a=S(e,t.useHalfFloat),o=We(e,t.palette),{backgroundColor:s,cursorColor:i,glintColor:n,cursorIntensity:l,glintIntensity:c,ditherMagnitude:f}=t,b=g("src/matrix/shaders/glsl/palettePass.frag.glsl"),v=e({frag:e.prop("frag"),uniforms:{backgroundColor:k(s),cursorColor:k(i),glintColor:k(n),cursorIntensity:l,glintIntensity:c,ditherMagnitude:f,tex:r.primary,bloomTex:r.bloom,paletteTex:o},framebuffer:a});return T({primary:a},b.loaded,(P,d)=>a.resize(P,d),P=>{P&&v({frag:b.text()})})},$e=[{space:"rgb",values:[.36,.81,.98]},{space:"rgb",values:[.96,.66,.72]},{space:"rgb",values:[1,1,1]},{space:"rgb",values:[.96,.66,.72]},{space:"rgb",values:[.36,.81,.98]}].map(e=>Array(3).fill(e)).flat(),Ze=[{space:"rgb",values:[.89,.01,.01]},{space:"rgb",values:[1,.55,0]},{space:"rgb",values:[1,.93,0]},{space:"rgb",values:[0,.5,.15]},{space:"rgb",values:[0,.3,1]},{space:"rgb",values:[.46,.03,.53]}].map(e=>Array(2).fill(e)).flat(),A=({regl:e,config:t},r)=>{const a=S(e,t.useHalfFloat),{backgroundColor:o,cursorColor:s,glintColor:i,cursorIntensity:n,glintIntensity:l,ditherMagnitude:c}=t,f="stripeColors"in t?t.stripeColors:t.effect==="pride"?Ze:$e,b=ve(e,f.map(d=>[...k(d),1])),v=g("src/matrix/shaders/glsl/stripePass.frag.glsl"),P=e({frag:e.prop("frag"),uniforms:{backgroundColor:k(o),cursorColor:k(s),glintColor:k(i),cursorIntensity:n,glintIntensity:l,ditherMagnitude:c,tex:r.primary,bloomTex:r.bloom,stripeTex:b},framebuffer:a});return T({primary:a},v.loaded,(d,x)=>a.resize(d,x),d=>{d&&P({frag:v.text()})})},Ke="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0a/Flammarion_Colored.jpg/917px-Flammarion_Colored.jpg",Je=({regl:e,config:t},r)=>{const a=S(e,t.useHalfFloat),o="bgURL"in t?t.bgURL:Ke,s=q(e,o),i=g("src/matrix/shaders/glsl/imagePass.frag.glsl"),n=e({frag:e.prop("frag"),uniforms:{backgroundTex:s.texture,tex:r.primary,bloomTex:r.bloom},framebuffer:a});return T({primary:a},Promise.all([s.loaded,i.loaded]),(l,c)=>a.resize(l,c),l=>{l&&n({frag:i.text()})})},et=({regl:e,config:t,lkg:r},a)=>{if(!r.enabled)return T({primary:a.primary});const o=S(e,t.useHalfFloat),s=g("src/matrix/shaders/glsl/quiltPass.frag.glsl"),i=e({frag:e.prop("frag"),uniforms:{quiltTexture:a.primary,...r},framebuffer:o});return T({primary:o},Promise.all([s.loaded]),(n,l)=>o.resize(n,l),n=>{n&&i({frag:s.text()})})};let we;const Se=5,Q=Array(Se).fill([0,0,-1/0]).flat();let ge=1,B=0;window.onclick=e=>{Q[B*3+0]=0+e.clientX/e.srcElement.clientWidth,Q[B*3+1]=1-e.clientY/e.srcElement.clientHeight,Q[B*3+2]=(Date.now()-we)/1e3,B=(B+1)%Se};const tt=({regl:e,config:t,cameraTex:r,cameraAspectRatio:a},o)=>{const s=S(e,t.useHalfFloat),i=g("src/matrix/shaders/glsl/mirrorPass.frag.glsl"),n=e({frag:e.prop("frag"),uniforms:{time:e.context("time"),tex:o.primary,bloomTex:o.bloom,cameraTex:r,clicks:()=>Q,aspectRatio:()=>ge,cameraAspectRatio:a},framebuffer:s});return we=Date.now(),T({primary:s},Promise.all([i.loaded]),(l,c)=>{s.resize(l,c),ge=l/c},l=>{l&&n({frag:i.text()})})},rt={buttons:[0,0,0,0],calibration:{DPI:{value:324},center:{value:.15018756687641144},configVersion:"3.0",flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0},fringe:{value:0},invView:{value:1},pitch:{value:52.58013153076172},screenH:{value:2048},screenW:{value:1536},slope:{value:-7.145165920257568},verticalAngle:{value:0},viewCone:{value:40}},defaultQuilt:{quiltAspect:.75,quiltX:3840,quiltY:3840,tileX:8,tileY:6},hardwareVersion:"portrait",hwid:"LKG-P11063",index:0,joystickIndex:-1,state:"ok",unityIndex:1,windowCoords:[1440,900]},te=e=>{if(e==null)return{enabled:!1,tileX:1,tileY:1};const t=15,r=Object.fromEntries(Object.entries(e.calibration).map(([c,f])=>[c,f.value]).filter(([c,f])=>f!=null)),a=r.screenW/r.DPI,o=r.pitch*a*Math.cos(Math.atan(1/r.slope)),s=r.screenH/(r.screenW*r.slope)*-(r.flipImageX*2-1),i=1/(r.screenW*3),n=e.defaultQuilt,l=[Math.floor(n.quiltX/n.tileX)*n.tileX/n.quiltX,Math.floor(n.quiltY/n.tileY)*n.tileY/n.quiltY];return{...n,...r,pitch:o,tilt:s,subp:i,quiltViewPortion:l,fov:t,enabled:!0}},at=async(e=!1,t=!1)=>{if(!e)return te(null);const r=await Le(()=>import("./holoplaycore.module-09fbf441.js"),[]),a=await new Promise((o,s)=>new r.Client(i=>{var n;return o((n=i.devices)==null?void 0:n[0])},i=>o(null)));return a==null&&t?te(rt):te(a)},Pe={none:null,plain:xe,palette:xe,customStripes:A,stripes:A,pride:A,transPride:A,trans:A,image:Je,mirror:tt},j={width:1,height:1},ye=e=>new Promise((t,r)=>{const a=document.createElement("script");a.onload=t,a.onerror=r,a.src=e,document.body.appendChild(a)}),nt=async(e,t)=>{await Promise.all([ye("./src/matrix/lib/regl.min.js"),ye("./src/matrix/lib/gl-matrix.js")]);const r=()=>{const u=window.devicePixelRatio??1;e.width=Math.ceil(e.clientWidth*u*t.resolution),e.height=Math.ceil(e.clientHeight*u*t.resolution)};window.onresize=r,(document.fullscreenEnabled||document.webkitFullscreenEnabled)&&(window.ondblclick=()=>{document.fullscreenElement==null?e.webkitRequestFullscreen!=null?e.webkitRequestFullscreen():e.requestFullscreen():document.exitFullscreen()}),r(),t.useCamera&&await qe();const a=["OES_texture_half_float","OES_texture_half_float_linear"],o=["EXT_color_buffer_half_float","WEBGL_color_buffer_float","OES_standard_derivatives"];switch(t.testFix){case"fwidth_10_1_2022_A":a.push("OES_standard_derivatives");break;case"fwidth_10_1_2022_B":o.forEach(u=>a.push(u)),a.length=0;break}const s=createREGL({canvas:e,pixelRatio:1,extensions:a,optionalExtensions:o}),i=s.texture(fe),n=await at(t.useHoloplay,!0),l=Oe(s),c=t.effect in Pe?t.effect:"palette",b=Xe({regl:s,config:t,lkg:n,cameraTex:i,cameraAspectRatio:ze},[Ge,Ne,Pe[c],et]),v={tex:b[b.length-1].outputs.primary},P=s({uniforms:v});await Promise.all(b.map(u=>u.ready));const d=1e3/t.fps;let x=NaN;const M=s.frame(({viewportWidth:u,viewportHeight:m})=>{t.once&&M.cancel();const _=s.now()*1e3;isNaN(x)&&(x=_);const y=t.fps>=60||_-x>=d||t.once==!0;if(y)for(;_-d>x;)x+=d;if(t.useCamera&&i(fe),j.width!==u||j.height!==m){j.width=u,j.height=m;for(const C of b)C.setSize(u,m)}l(()=>{for(const C of b)C.execute(y);P()})})};export{nt as default};
